(()=>{"use strict";class t{constructor(){this.wrapper=document.querySelector(".lp-migration-wrapper .content.learndash"),this.wrapper&&(this.restNamespace=LP_ADDON_IMPORT_EXPORT_GLOBAL_OBJECT?.rest_namespace||"",this.bodyNode=document.querySelector("body"),this.stepTotals={content:parseInt(LP_ADDON_IMPORT_EXPORT_GLOBAL_OBJECT?.learndash_content_total)||100,student_migrate:parseInt(LP_ADDON_IMPORT_EXPORT_GLOBAL_OBJECT?.learndash_student_migrate_total)||100},this.icons={checked:'<svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">\n                <path fill-rule="evenodd" clip-rule="evenodd" d="M8 1.33333C4.3181 1.33333 1.33333 4.3181 1.33333 8C1.33333 11.6819 4.3181 14.6667 8 14.6667C11.6819 14.6667 14.6667 11.6819 14.6667 8C14.6667 4.3181 11.6819 1.33333 8 1.33333ZM0 8C0 3.58172 3.58172 0 8 0C12.4183 0 16 3.58172 16 8C16 12.4183 12.4183 16 8 16C3.58172 16 0 12.4183 0 8Z" fill="#34C759"/>\n                <path d="M11.0685 5.4759L7.54764 9.62136L5.58892 7.66984C5.37262 7.45166 5.03615 7.4759 4.81985 7.66984C4.60355 7.88802 4.62758 8.22742 4.81985 8.4456L7.01891 10.6153C7.16311 10.7608 7.35538 10.8335 7.54764 10.8335C7.73991 10.8335 7.93218 10.7608 8.07638 10.6153L11.8376 6.2759C12.0539 6.05772 12.0539 5.71833 11.8376 5.50014C11.6213 5.28196 11.2848 5.28196 11.0685 5.4759Z" fill="#34C759"/>\n            </svg>',unchecked:'<svg width="16" height="17" fill="none" xmlns="http://www.w3.org/2000/svg">\n                <path d="M8 1.83333C4.3181 1.83333 1.33333 4.8181 1.33333 8.5C1.33333 12.1819 4.3181 15.1667 8 15.1667C11.6819 15.1667 14.6667 12.1819 14.6667 8.5C14.6667 4.8181 11.6819 1.83333 8 1.83333ZM0 8.5C0 4.08172 3.58172 0.5 8 0.5C12.4183 0.5 16 4.08172 16 8.5C16 12.9183 12.4183 16.5 8 16.5C3.58172 16.5 0 12.9183 0 8.5Z" fill="#8A8888"></path>\n                <path d="M11.0688 5.9759L7.54789 10.1214L5.58916 8.16984C5.37286 7.95166 5.03639 7.9759 4.82009 8.16984C4.60379 8.38802 4.62783 8.72742 4.82009 8.9456L7.01915 11.1153C7.16335 11.2608 7.35562 11.3335 7.54789 11.3335C7.74016 11.3335 7.93242 11.2608 8.07662 11.1153L11.8379 6.7759C12.0542 6.55772 12.0542 6.21833 11.8379 6.00014C11.6216 5.78196 11.2851 5.78196 11.0688 5.9759Z" fill="#8A8888"></path>\n            </svg>',loader:'<div class="loader"></div>'},this.popups={beforeMigrate:document.querySelector("#lp-before-migrate-popup"),clearData:document.querySelector("#lp-clear-migrated-data-popup"),success:document.querySelector("#lp-migrate-success-popup")},this.initElements(),this.bindEvents())}initElements(){this.statusNode=this.wrapper.querySelector(".status"),this.autoMigrateBtn=this.wrapper.querySelector("#lp-auto-migrate-btn.learndash"),this.clearDataBtn=this.wrapper.querySelector("#lp-clear-migrate-btn"),this.steps={content:this.getStepElements(".step-content"),student_migrate:this.getStepElements(".step-student-migrate")},this.migrateItemCheckboxes=this.wrapper.querySelectorAll(".migrate-item .migrate-item-checkbox")}getStepElements(t){const e=this.wrapper.querySelector(t);return e?{node:e,progressBar:e.querySelector(".progress-bar"),total:e.querySelector(".migrated-total"),icon:e.querySelector(".migrate-item-checkbox")}:null}bindEvents(){this.bindAutoMigration(),this.bindClearData(),this.bindSuccessPopup()}bindAutoMigration(){if(!this.autoMigrateBtn||!this.popups.beforeMigrate)return;this.autoMigrateBtn.addEventListener("click",(()=>{this.popups.beforeMigrate.classList.add("active"),this.bodyNode.classList.add("lp-no-scroll")}));const t=()=>{this.popups.beforeMigrate.classList.remove("active"),this.bodyNode.classList.remove("lp-no-scroll")},e=this.popups.beforeMigrate.querySelector("button.migrate-now");e?.addEventListener("click",(()=>{t(),this.autoMigrateBtn.disabled=!0,this.reset(),this.removeStatus(),this.migrate()})),this.popups.beforeMigrate.querySelector("button.cancel")?.addEventListener("click",t),this.popups.beforeMigrate.querySelector(".dashicons-no-alt")?.addEventListener("click",t)}bindClearData(){if(!this.clearDataBtn||!this.popups.clearData)return;this.clearDataBtn.addEventListener("click",(()=>{this.popups.clearData.classList.add("active"),this.bodyNode.classList.add("lp-no-scroll")}));const t=()=>{this.popups.clearData.classList.remove("active"),this.bodyNode.classList.remove("lp-no-scroll")};this.popups.clearData.querySelector("button.cancel")?.addEventListener("click",t),this.popups.clearData.querySelector(".dashicons-no-alt")?.addEventListener("click",t);const e=this.popups.clearData.querySelector("button.clear-migrated");e?.addEventListener("click",(e=>{e.preventDefault(),t(),this.clearDataBtn.disabled=!0,this.setAllCheckboxes(this.icons.loader),wp.apiFetch({path:`/${this.restNamespace}/delete-migrated-data/learndash`,method:"DELETE"}).then((t=>{"success"===t.status?(this.showStatus(t.msg,"success"),this.reset(),this.autoMigrateBtn.disabled=!1):this.showStatus(t.msg,"error")})).catch((t=>{console.error(t)})).finally((()=>{this.clearDataBtn.disabled=!1}))}))}bindSuccessPopup(){if(!this.popups.success)return;const t=()=>{this.popups.success.classList.remove("active"),this.bodyNode.classList.remove("lp-no-scroll")};this.popups.success.querySelector("a.remove-popup")?.addEventListener("click",t),this.popups.success.querySelector(".bg-overlay")?.addEventListener("click",t),this.popups.success.querySelector(".view-report")?.addEventListener("click",(e=>{e.preventDefault(),t(),window.location.reload()}))}reset(){Object.values(this.steps).forEach((t=>{t&&(t.progressBar.style.width="0%",t.total.innerHTML="0")})),this.setAllCheckboxes(this.icons.unchecked)}removeStatus(){this.statusNode.innerHTML="",this.statusNode.classList.remove("lp-migration-success","lp-migration-error")}showStatus(t,e){this.statusNode.innerHTML=t,this.statusNode.classList.remove("lp-migration-success","lp-migration-error"),this.statusNode.classList.add(`lp-migration-${e}`)}setAllCheckboxes(t){this.migrateItemCheckboxes.forEach((e=>{e.innerHTML=t}))}setLoading(t){const e=this.steps[t];e?.icon&&!e.icon.querySelector(".loader")&&(e.icon.innerHTML=this.icons.loader)}migrate(t=1,e="content"){this.setLoading(e),wp.apiFetch({path:`/${this.restNamespace}/migrate/learndash`,method:"POST",data:{paged:t,number:20,item:e}}).then((t=>{"success"===t.status?(this.updateProgress(e,t.data),t.data?.next_migrate_item?this.migrate(t.data.next_page,t.data.next_migrate_item):this.onMigrationComplete(e,t)):this.showStatus(t.msg,"error")})).catch((t=>{console.error(t)}))}updateProgress(t,e){const s=this.steps[t];if(!s)return;const i=e?.migrated_total||0,a=this.stepTotals[t]||100,r=Math.min(100,(i/a*100).toFixed(0));s.progressBar&&(s.progressBar.style.width=`${r}%`),s.total&&(s.total.innerHTML=i),e?.next_migrate_item&&e.next_migrate_item!==t&&s.icon&&(s.icon.innerHTML=this.icons.checked)}onMigrationComplete(t,e){this.showStatus(e.msg,"success"),this.clearDataBtn.disabled=!1,"student_migrate"===t&&this.steps.student_migrate?.icon&&(this.steps.student_migrate.icon.innerHTML=this.icons.checked),setTimeout((()=>{this.displaySuccessPopup(e.data)}),1e3)}displaySuccessPopup(t){this.popups.success&&(this.popups.success.querySelector(".migrate-result").innerHTML=t.migrate_success_html,this.popups.success.classList.add("active"),this.bodyNode.classList.add("lp-no-scroll"))}}document.addEventListener("DOMContentLoaded",(()=>{new t}))})();